<html>
<head>
<script language="javascript" src="http://jqueryjs.googlecode.com/files/jquery-1.2.6.js"></script>
<script language="javascript">

/*

COPYRIGHT AND LICENCE

Copyright (C) 2006-2008 Infinity Interactive, Inc.

http://www.iinteractive.com

This library is free software; you can redistribute it 
and/or modify it under the same terms as Perl itself. 

*/

/**************** Templating Objects ****************/

function Param (value) { this.value = value }
Param.prototype.find_and_replace = function (template, selector, value) {
    template.find(selector)
            .each(function () { jQuery(this).html(value) })
}
Param.prototype.render = function (template, selector) {
    this.find_and_replace(template, selector, this.value);    
}

function Thunk (func) {
    this.func = func;
}
Thunk.prototype        = new Param ();
Thunk.prototype.render = function (template, selector) {
    this.find_and_replace(
        template, 
        selector, 
        this.func(template, selector)
    );    
}

function MethodThunk (invocant, method_name) {
    this.func = function () { return invocant[method_name]() }
}
MethodThunk.prototype = new Thunk ();

function PropertyThunk (invocant, property_name) {
    this.func = function () { return invocant[property_name] }
}
PropertyThunk.prototype = new Thunk ();

function Collection (params) {
    this.css_selector = params['css_selector'];
    this.values       = params['values'];
    this.transformer  = params['transformer'];
}
Collection.prototype            = new Param ();
Collection.prototype.get_values = function () {
    return (this.transformer == undefined)
        ? this.values
        : jQuery.map(this.values, this.transformer)
}
Collection.prototype.render     = function (template, selector) {
    var selection = template.find(selector).find(this.css_selector);
    var target    = selection.parent();
    target.empty();
    jQuery.each(
        this.get_values(),
        function () { 
            target.append(
                selection.clone(true).process_template(this)
            ) 
        }
    );    
}

function Hierarchy (params) {
    this.list_selector = params['list_selector'];
    this.item_selector = params['item_selector'];
    this.values        = params['values'];
}
Hierarchy.prototype            = new Param ();
Hierarchy.prototype.get_values = function () { return this.values }
Hierarchy.prototype.render     = function (template, selector) {
    var selection      = template.find(selector);
    var list_selection = selection.find(this.list_selector);
    var item_selection = selection.find(this.item_selector);

    selection.empty();
    list_selection.empty();

    var traverse = function (element, tree) {
        // build a node ...
        var node_element = item_selection.clone(true).process_template(
            tree['node']
        );
        element.append(node_element);
        // if the node has children then ...
        if (tree['children'] != undefined) {
            var new_element = list_selection.clone(true);
            jQuery.each(
                tree['children'],
                function () {
                    traverse(new_element, this);
                    node_element.append(new_element);
                }
            );
        }
    };
    
    // create the root ...
    var root_node = list_selection.clone(true);
    traverse(root_node, this.get_values());
    selection.append(root_node);    
}

/************* JQuery Plugin *******************/

jQuery.fn.extend({
    process_template : function (params) {
        var template = this;
        jQuery.each(
            params,
            function (selector, param) {                    
                ((typeof param == 'object')
                    ? param
                    : new Param (param)).render(template, selector)
            }
        );
        return template;
    }
});

/********************** Paramters ***************************/

function User (name) {
    this._name = name;
}
User.prototype.name = function () { return this._name }

function Product (id, name) {
    this._id = id;
    this.name = name;
}
Product.prototype.get_id = function () { return this._id }

var params = {
    '#logo'           : new Thunk (function (t, selector) {
        t.find(selector).attr({
            'src'   : 'http://iinteractive.com/images/logo.gif',
            'style' : 'padding: 10px;',
        });
    }),
    '.username'       : new MethodThunk (new User ('Stevan'), "name"),
    '#user_quotation' : 'JQuery Rocks',
    '.copyright'      : new Thunk (function () { return "Copyright (c) " + (new Date ()).getFullYear() }),
    '#products'       : new Collection ({
        css_selector  : '.row',
        values        : [
            new Product (10, 'Foo'),
            new Product (11, 'Bar'),
            new Product (12, 'Baz'),
        ],
        transformer   : function (val) {
            return {
                '.id'   : val.get_id(),
                '.name' : new PropertyThunk (val, 'name'),
            }
        }
    }),
    '#dogs'          : new Collection ({
        css_selector : '.table_row',
        values       : [
            { '.sound' : "Bark" },
            { '.sound' : "Woof" },
        ]
    }),
    '#cats'          : new Hierarchy ({
        list_selector : '.list',
        item_selector : '.item',
        values       : {
            node     : { '.name' : "Twinkles"  },
            children : [
                { node : { '.name' : "Shnuckums" } },
                { 
                    node     : { '.name' : "Bilbo" },
                    children : [
                        { 
                            node     : { '.name' : "Dweezil" },
                            children : [
                                { node : { '.name' : "Tabby" } },                      
                            ]
                        },
                        { node : { '.name' : "Abraxas"    } },                                                
                    ]
                },
            ]
        }
    }),
    '#rooms'          : new Hierarchy ({
        list_selector : '.list',
        item_selector : '.item',
        values       : {
            node     : { '.name' : "Ceiling"  },
            children : [
                { node : { '.name' : "Basement" } },
                { 
                    node     : { '.name' : "Garage" },
                    children : [
                        { node : { '.name' : "Root Cellar" } },
                        { 
                            node     : { '.name' : "Kitchen" },
                            children : [
                                { node : { '.name' : "Under The Stairs" } },                      
                            ]
                        },
                        { node : { '.name' : "Bathroom"    } },                                                
                    ]
                },
            ]
        }
    }),    
};

$(document).ready(function () {
    $('body').process_template(params);
});

</script>
</head>
<body>
<img id="logo" src="http://l.yimg.com/a/i/ww/beta/y3.gif" border="1" />
<hr/>
<div class="username">Foo</div>
<hr/>
<p id="user_quotation">Text goes here</p>
<div id="products" style="border: 1px solid grey; width: 250px">
    <div class="row" style="border: 1px solid red; padding: 2px; margin: 2px;">
        <span class="id">ID</span>
        <span class="name">NAME</span>
    </div>
</div>
<br/>
<table id="dogs" border="1">
    <thead>
        <th>Hello</th>
    </thead>
    <tbody>
        <tr class="table_row">
            <td>My dog says <span class="sound">NAME</span></td>
        </tr>
    </tbody>
</table>
<hr/>
<div id="cats">
    <ul class="list">
        <li class="item">My cat is named <span class="name">NAME</span></li>
    </ul>
</div>
<hr/>
<div id="rooms">
    <div class="list" style="padding-left: 10px">
        <div class="item" style="padding-left: 10px">My room is <span class="name">NAME</span></div>
    </div>
</div>
<hr/>
<div class="username">Foo</div>
<hr/>
<div class="copyright">Copyleft</div>
</body>
</html>
